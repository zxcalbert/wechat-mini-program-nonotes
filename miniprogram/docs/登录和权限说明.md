# 登录功能和权限控制说明

## 新增功能

### 1. 登录页面 (`pages/login/login`)
- 用户首次使用应该进入登录页面
- 点击"用微信账号登录"，授权获取微信头像和昵称
- 系统自动获取用户的 `openid`（微信唯一标识）
- 保存用户信息到本地存储

### 2. 权限控制
所有页面都添加了登录检查：
- `pages/index/index`：列表页面检查登录状态
- `pages/write/write`：写信页面检查登录状态  
- `pages/detail/detail`：详情页面检查登录状态+权限验证

### 3. 登录云函数 (`cloudfunctions/login`)
- 获取用户的 `openid`
- 创建用户记录到 `users` 集合
- 更新最后登录时间

---

## 数据隐私保护

### 数据关联
每条数据都关联用户 `_openid`：
```javascript
{
  _openid: "user's openid",  // 用户唯一标识
  // ... other fields
}
```

### 数据库权限规则配置

需要在云开发控制台为以下集合配置权限规则：

#### letters（信件集合）
```javascript
{
  "read": "auth.uid != null && auth.uid == doc._openid",
  "write": "auth.uid != null && auth.uid == doc._openid",  
  "update": "auth.uid != null && auth.uid == doc._openid",
  "delete": "auth.uid != null && auth.uid == doc._openid"
}
```

#### users（用户集合）
```javascript
{
  "read": "auth.uid != null && auth.uid == doc._openid",
  "write": "auth.uid != null && auth.uid == doc._openid",
  "update": "auth.uid != null && auth.uid == doc._openid",
  "delete": "auth.uid != null && auth.uid == doc._openid"
}
```

#### letterReplies（回复集合，如果有）
```javascript
{
  "read": "auth.uid != null && auth.uid == doc._openid",
  "write": "auth.uid != null && auth.uid == doc._openid",
  "update": "auth.uid != null && auth.uid == doc._openid",
  "delete": "auth.uid != null && auth.uid == doc._openid"
}
```

### 前端权限检查
- 详情页面加载时验证 `_openid` 是否匹配当前用户
- 用户只能查看/修改/删除自己的数据

---

## 使用流程

### 首次使用
1. 打开小程序 → 进入登录页面
2. 点击"用微信账号登录"
3. 授权后自动跳转到首页
4. 可以开始写信

### 已登录用户
1. 直接进入首页（无需重新登录）
2. 可以查看自己的所有信件
3. 可以写新信、查看回复、删除信件

### 退出登录
- 在登录页面（重新打开小程序）点击"退出登录"
- 清除本地保存的用户信息

---

## 配置检查清单

- [ ] 在云开发控制台创建 `users` 集合
- [ ] 在云开发控制台创建 `letters` 集合  
- [ ] 在云开发控制台创建 `letterReplies` 集合（可选）
- [ ] 为 `letters` 集合配置权限规则
- [ ] 为 `users` 集合配置权限规则
- [ ] 为 `letterReplies` 集合配置权限规则
- [ ] 部署 `login` 云函数
- [ ] 在小程序中测试登录流程
- [ ] 验证非所有者无法访问他人的数据

---

## 常见问题

**Q: 用户退出后重新登录，还能看到之前的信件吗？**
A: 可以。因为信件是按 `_openid` 关联存储的，只要是同一个微信账号登录，就能看到所有历史信件。

**Q: 如何防止用户在浏览器控制台修改本地存储的数据？**
A: 前端修改数据后，数据库权限规则会验证，云函数和云数据库层面的权限检查是真正的防护。

**Q: 为什么需要 `_openid` 而不用其他方式？**
A: `_openid` 是微信云开发内置的用户唯一标识，由微信服务器认证，最安全可靠。
