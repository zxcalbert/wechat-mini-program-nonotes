# CloudBase 权限配置完整指南

## 📚 方法一：使用脚本自动配置（推荐）

### 前置条件
1. 已安装 Node.js 和 npm
2. 拥有腾讯云 API 密钥

### 步骤 1：获取 API 密钥

访问 [腾讯云 API 密钥页面](https://console.cloud.tencent.com/cam/capi)：

1. 登录腾讯云控制台
2. 进入 **访问管理** → **API 密钥管理**
3. 查看或新建密钥：
   - **SecretId** (API Key ID)
   - **SecretKey** (API Key)

### 步骤 2：运行配置脚本

```bash
# 进入项目目录
cd /Users/bill/编程/invest-diary

# 运行脚本（替换为您的实际密钥）
bash 配置数据库权限.sh <您的SecretId> <您的SecretKey>
```

**示例：**
```bash
bash 配置数据库权限.sh AKID1234567890ABCD wxyz123456
```

### 步骤 3：验证配置

脚本会输出：
```
✅ 权限配置完成！

📌 配置说明：
   • 读权限: 用户只能读取自己的数据 (doc._openid == auth.uid)
   • 写权限: 用户只能修改自己的数据 (doc._openid == auth.uid)

⏱️  注意：规则更新可能需要 2-5 分钟才能生效
```

---

## 📚 方法二：使用 CloudBase CLI 手动配置

### 安装 CLI 工具

```bash
npm install -g cloudbase-cli
```

### 登录

```bash
cloudbase login
```

按照提示输入腾讯云 API 密钥。

### 配置权限

```bash
# 设置 letters 集合的权限
cloudbase db:rule:set letters /path/to/rules.json --env cloud1-7gtwuw5665620997
```

其中 `rules.json` 内容为：

```json
{
  "read": "doc._openid == auth.uid",
  "write": "doc._openid == auth.uid"
}
```

---

## 📚 方法三：通过云开发控制台手动配置（图形界面）

### 步骤 1：打开云开发控制台

访问 [CloudBase 控制台](https://console.cloudbase.net/)

### 步骤 2：选择环境

1. 进入 **云开发** 控制台
2. 选择环境：**cloud1-7gtwuw5665620997**

### 步骤 3：进入数据库

1. 在左侧菜单找到 **数据库**
2. 选择 **数据库集合**

### 步骤 4：配置 letters 集合权限

1. 找到 `letters` 集合
2. 点击 **权限** 标签页
3. 选择 **自定义安全规则** (CUSTOM)
4. 在 **读权限** 输入框填写：
   ```
   doc._openid == auth.uid
   ```

5. 在 **写权限** 输入框填写：
   ```
   doc._openid == auth.uid
   ```

6. 点击 **保存** 按钮

### 步骤 5：等待生效

- 权限更改通常在 2-5 分钟内生效
- 可以刷新页面查看最新状态

---

## 🔐 权限规则详解

### 为什么需要权限配置？

权限规则保护用户数据：
- ✅ 用户只能访问自己的数据
- ✅ 防止其他用户读取或修改您的数据
- ✅ 确保数据隐私和安全

### 规则含义

```javascript
// 读权限
"doc._openid == auth.uid"
// 含义：只有当文档的 _openid 等于当前用户的 uid 时，才允许读取

// 写权限
"doc._openid == auth.uid"
// 含义：只有当文档的 _openid 等于当前用户的 uid 时，才允许修改
```

### 魔术变量

| 变量 | 含义 |
|------|------|
| `auth.uid` | 当前登录用户的唯一标识 |
| `doc._openid` | 文档所有者的用户标识 |
| `auth.loginType` | 用户登录方式 |

---

## 📊 其他常见权限配置

### 公开读、只有所有者可写

```json
{
  "read": true,
  "write": "doc._openid == auth.uid"
}
```

### 仅超级管理员可读写

```json
{
  "read": "auth.uid == 'admin_user_id'",
  "write": "auth.uid == 'admin_user_id'"
}
```

### 所有人都可以读写（不安全，仅用于测试）

```json
{
  "read": true,
  "write": true
}
```

---

## 🔧 权限配置常见问题

### Q1: 配置后无法查询数据

**原因：** 权限还未生效或规则配置错误

**解决：**
1. 等待 5 分钟后重试
2. 检查集合中文档的 `_openid` 字段是否正确
3. 确认已登录（`auth.uid` 不为空）
4. 在控制台查看权限规则是否已正确保存

### Q2: 权限规则不生效

**原因：** 可能是缓存问题

**解决：**
1. 清除微信开发者工具的缓存
2. 关闭微信开发者工具后重新打开
3. 重新进入小程序页面

### Q3: 如何查看当前权限规则？

在云开发控制台中：
1. 进入 **数据库**
2. 选择 `letters` 集合
3. 点击 **权限** 标签页查看当前规则

### Q4: 能否允许特定用户访问他人数据？

可以，使用更复杂的规则：

```javascript
// 允许用户访问自己或被共享的数据
"doc._openid == auth.uid || auth.uid in doc.sharedWith"
```

---

## ✅ 验证权限配置

### 代码验证

在 `pages/index/index.js` 中，如果看到以下日志说明权限配置正确：

```javascript
// 应该能查询到数据
const result = await cloudbaseUtil.query('letters', {
  where: { _openid: '{openid}' }
});

if (result.success) {
  console.log('✅ 权限配置正确，查询成功');
  console.log('数据:', result.data);
} else {
  console.error('❌ 权限配置可能有问题:', result.error);
}
```

### 云开发控制台验证

1. 打开 **云开发控制台**
2. 进入 **数据库** → **letters** 集合
3. 查看集合中的文档，确认 `_openid` 字段存在且有值

---

## 🚀 配置完成后的工作流

### 1️⃣ 权限配置完成（✅ 您将在这里）

```bash
bash 配置数据库权限.sh <SecretId> <SecretKey>
```

### 2️⃣ 更新小程序页面

将 `index.improved.js` 的代码复制到 `pages/index/index.js`：

```javascript
const cloudbaseUtil = require('../../utils/cloudbaseUtil');

Page({
  async onShow() {
    const result = await cloudbaseUtil.query('letters', {
      where: { _openid: '{openid}' },
      orderBy: 'createTime',
      orderDirection: 'desc'
    });

    if (result.success) {
      this.setData({ letters: result.data });
    }
  }
});
```

### 3️⃣ 测试数据库操作

- 新增信件
- 查看列表
- 更新状态
- 删除信件

### 4️⃣ 部署云函数

确保已部署最新版本的 `replyToLetter` 函数（支持 Gemini API）

---

## 📞 需要帮助？

如果出现权限问题：

1. **检查清单：**
   - ✅ API 密钥是否正确
   - ✅ 集合名称是否正确（应为 `letters`）
   - ✅ 环境 ID 是否正确（应为 `cloud1-7gtwuw5665620997`）
   - ✅ 等待了足够的时间（2-5 分钟）

2. **查看日志：**
   ```javascript
   console.log('权限错误详情:', result.error);
   ```

3. **查阅文档：**
   - [CloudBase 官方文档](https://docs.cloudbase.net/)
   - [安全规则指南](https://docs.cloudbase.net/database/security/index.html)
