# CloudBase 数据库操作高级示例

本文档提供微信小程序中 CloudBase 文档数据库的高级使用示例。

## 1. 批量操作示例

### 批量更新用户信息

```javascript
// 将所有待回复的信件标记为已读
async markAllPendingAsRead() {
  const result = await cloudbaseUtil.updateBatch('letters',
    { status: 'pending' }, // 查询条件
    { status: 'read' }     // 更新数据
  );
  
  console.log(`已更新 ${result.updated} 条记录`);
}
```

## 2. 条件查询示例

### 使用高级查询条件

```javascript
const db = wx.cloud.database();
const _ = db.command;

// 查询最近7天内的信件
async fetchRecentLetters() {
  const sevenDaysAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000);
  
  const result = await cloudbaseUtil.query('letters', {
    where: {
      createTime: _.gte(sevenDaysAgo),
      _openid: '{openid}'
    },
    orderBy: 'createTime',
    orderDirection: 'desc'
  });
  
  return result.data;
}
```

### 模糊搜索

```javascript
// 搜索内容包含关键词的信件
async searchLetters(keyword) {
  const db = wx.cloud.database();
  const _ = db.command;
  
  const result = await cloudbaseUtil.query('letters', {
    where: {
      content: _.regex(keyword),
      _openid: '{openid}'
    }
  });
  
  return result.data;
}
```

### 多条件查询

```javascript
// 查询特定导师的已回复信件
async fetchRepliedByMentor(mentor) {
  const db = wx.cloud.database();
  const _ = db.command;
  
  const result = await cloudbaseUtil.query('letters', {
    where: {
      mentor: mentor,
      status: _.in(['replied', 'read']),
      _openid: '{openid}'
    },
    orderBy: 'replyTime',
    orderDirection: 'desc'
  });
  
  return result.data;
}
```

## 3. 分页加载示例

### 列表分页展示

```javascript
Page({
  data: {
    letters: [],
    pageIndex: 1,
    hasMore: true,
    loading: false
  },

  onLoad() {
    this.loadLetters();
  },

  /**
   * 加载第一页
   */
  async loadLetters() {
    this.setData({ loading: true, pageIndex: 1 });
    await this.loadMoreLetters();
  },

  /**
   * 加载更多（用于上拉触底）
   */
  async loadMoreLetters() {
    const result = await cloudbaseUtil.queryWithPagination('letters', {
      where: { _openid: '{openid}' },
      orderBy: 'createTime',
      orderDirection: 'desc',
      pageIndex: this.data.pageIndex,
      pageSize: 10
    });

    if (result.success) {
      const letters = this.data.pageIndex === 1 
        ? result.data 
        : this.data.letters.concat(result.data);

      this.setData({
        letters,
        hasMore: result.pageIndex < result.pageCount,
        loading: false
      });
    }
  },

  /**
   * 上拉触底
   */
  onReachBottom() {
    if (this.data.hasMore && !this.data.loading) {
      this.setData({ pageIndex: this.data.pageIndex + 1 });
      this.loadMoreLetters();
    }
  }
});
```

## 4. 统计和聚合示例

### 使用聚合管道进行统计

```javascript
/**
 * 获取各个导师的回复数量统计
 */
async getMentorStats() {
  const result = await cloudbaseUtil.aggregate('letters', [
    {
      $match: {
        _openid: '{openid}',
        status: 'replied'
      }
    },
    {
      $group: {
        _id: '$mentor',
        count: {
          $sum: 1
        }
      }
    },
    {
      $sort: {
        count: -1
      }
    }
  ]);

  if (result.success) {
    return result.data;
  }
  return [];
}

/**
 * 按心境分组统计
 */
async getMoodStats() {
  const result = await cloudbaseUtil.aggregate('letters', [
    {
      $match: { _openid: '{openid}' }
    },
    {
      $group: {
        _id: '$mood',
        count: { $sum: 1 },
        avgLength: { $avg: { $strLenCP: '$content' } }
      }
    }
  ]);

  return result.success ? result.data : [];
}
```

## 5. 实时更新示例

### 实时监听数据变化

```javascript
/**
 * 监听用户的信件变化
 */
setupWatcher() {
  const db = wx.cloud.database();
  
  db.collection('letters')
    .where({ _openid: '{openid}' })
    .orderBy('createTime', 'desc')
    .watch({
      onChange: (snapshot) => {
        console.log('数据发生变化:', snapshot.docs);
        this.setData({ letters: snapshot.docs });
      },
      onError: (err) => {
        console.error('监听错误:', err);
      }
    });
}
```

## 6. 事务操作示例

### 批量写入（原子性操作）

```javascript
/**
 * 创建信件和相关元数据的原子操作
 */
async createLetterWithMetadata(letterData, metadata) {
  const batch = wx.cloud.database().batch();
  
  // 添加信件
  const letterRef = batch.collection('letters').add({
    data: {
      ...letterData,
      createTime: new Date(),
      status: 'pending'
    }
  });

  // 添加元数据
  batch.collection('letterMetadata').add({
    data: {
      ...metadata,
      letterId: letterRef._id,
      createdAt: new Date()
    }
  });

  try {
    const result = await batch.commit();
    console.log('批量写入成功');
    return { success: true, data: result };
  } catch (err) {
    console.error('批量写入失败:', err);
    return { success: false, error: err.message };
  }
}
```

## 7. 错误处理最佳实践

### 完整的错误处理示例

```javascript
/**
 * 带完整错误处理的数据加载
 */
async fetchLettersWithErrorHandling() {
  this.setData({ loading: true, error: null });

  try {
    // 检查网络连接
    const networkInfo = await new Promise((resolve) => {
      wx.getNetworkType({
        success: resolve
      });
    });

    if (networkInfo.networkType === 'none') {
      throw new Error('网络连接失败，请检查网络设置');
    }

    // 执行查询
    const result = await cloudbaseUtil.query('letters', {
      where: { _openid: '{openid}' },
      limit: 20
    });

    if (!result.success) {
      throw new Error(result.error || '数据加载失败');
    }

    // 数据验证
    if (!Array.isArray(result.data)) {
      throw new Error('返回数据格式错误');
    }

    this.setData({ letters: result.data });

  } catch (err) {
    console.error('加载失败:', err);
    
    // 根据错误类型显示不同的提示
    let errorMsg = '加载失败';
    if (err.message.includes('网络')) {
      errorMsg = '网络连接失败';
    } else if (err.message.includes('权限')) {
      errorMsg = '没有访问权限';
    }

    this.setData({ error: errorMsg });
    
    wx.showToast({
      title: errorMsg,
      icon: 'error',
      duration: 2000
    });

  } finally {
    this.setData({ loading: false });
  }
}
```

## 8. 性能优化建议

### 查询优化

```javascript
// ❌ 不好的做法：查询所有数据再过滤
async badWay() {
  const result = await cloudbaseUtil.query('letters', { limit: 1000 });
  return result.data.filter(item => item.status === 'replied');
}

// ✅ 好的做法：在查询时就过滤
async goodWay() {
  const db = wx.cloud.database();
  const _ = db.command;
  
  return await cloudbaseUtil.query('letters', {
    where: {
      status: 'replied',
      _openid: '{openid}'
    },
    limit: 20
  });
}
```

### 缓存策略

```javascript
/**
 * 使用本地缓存减少数据库查询
 */
async getLettersWithCache() {
  const cacheKey = 'letters_cache';
  const cacheTime = 5 * 60 * 1000; // 5分钟缓存

  // 检查缓存
  const cached = wx.getStorageSync(cacheKey);
  if (cached && Date.now() - cached.timestamp < cacheTime) {
    return cached.data;
  }

  // 查询数据
  const result = await cloudbaseUtil.query('letters', {
    where: { _openid: '{openid}' },
    limit: 50
  });

  // 保存缓存
  if (result.success) {
    wx.setStorageSync(cacheKey, {
      data: result.data,
      timestamp: Date.now()
    });
  }

  return result.data;
}

/**
 * 清除缓存
 */
clearCache() {
  wx.removeStorageSync('letters_cache');
}
```

## 常见问题

### Q: 如何处理并发更新冲突？
A: 可以添加版本号或时间戳来检测冲突：

```javascript
async updateWithConflictDetection(docId, newData, expectedUpdateTime) {
  const current = await cloudbaseUtil.getById('letters', docId);
  
  if (current.data.updateTime.getTime() !== expectedUpdateTime) {
    return { success: false, error: '数据已被修改，请刷新后重试' };
  }
  
  return await cloudbaseUtil.update('letters', docId, newData);
}
```

### Q: 如何处理大量数据导入？
A: 使用批量操作而不是逐条插入：

```javascript
async bulkInsert(dataArray) {
  const batch = wx.cloud.database().batch();
  
  dataArray.forEach(item => {
    batch.collection('letters').add({
      data: item
    });
  });
  
  return await batch.commit();
}
```
